from virustotal_python import Virustotal
import os.path
from pprint import pprint
import time

API_KEY = "9414c6af25f86b857159d97380c8d110b34a2a4a35edea455d7b80e8c54f499e"

FILE_PATH = r"C:\Users\Titou\Documents\GitHub\projet-malware\projet-malware\test\analysis"

files = {"file": (os.path.basename(FILE_PATH), open(os.path.abspath(FILE_PATH), "rb"))}

vtotal = Virustotal(API_KEY=API_KEY, API_VERSION=2)
resp = vtotal.request("file/scan", files=files, method="POST")

if resp.response_code == 1:
    resource = resp.json()['resource']
    print(f"Scan request successfully queued. Checking report for resource: {resource}")

    while True:
        report_resp = vtotal.request(f"file/report", params={"resource": resource})
        if report_resp.response_code == 1:
            break
        elif report_resp.response_code == 0:
            print("Scan not finished yet. Waiting...")
            time.sleep(10)
        else:
            print(f"Error checking report: {report_resp.json()}")
            break

    pprint(report_resp.json())
else:
    print(f"Error submitting the file for scanning: {resp.json()}")
