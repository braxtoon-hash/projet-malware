from virustotal_python import Virustotal
import os.path
from pprint import pprint
import time

API_KEY = "9414c6af25f86b857159d97380c8d110b34a2a4a35edea455d7b80e8c54f499e"

FILE_PATH = r"test/keylogger.exe"

files = {"file": (os.path.basename(FILE_PATH), open(os.path.abspath(FILE_PATH), "rb"))}

vtotal = Virustotal(API_KEY=API_KEY, API_VERSION=2)
resp = vtotal.request("file/scan", files=files, method="POST")

if resp.response_code == 1:
    resource = resp.json()['resource']
    print(f"Scan request successfully queued. Checking report for resource: {resource}")

    while True:
        report_resp = vtotal.request(f"file/report", params={"resource": resource})
        if report_resp.response_code == 1:
            break
        elif report_resp.response_code == 0:
            print("Scan not finished yet. Waiting...")
            time.sleep(10)
        else:
            print(f"Error checking report: {report_resp.json()}")
            break

    report_data = report_resp.json()

    print(f"Scan Report for File: {os.path.basename(FILE_PATH)}")
    print(f"Resource: {report_data['resource']}")
    print(f"Permalink: {report_data['permalink']}")
    print(f"MD5: {report_data['md5']}")
    print(f"SHA1: {report_data['sha1']}")
    print(f"SHA256: {report_data['sha256']}")
    print(f"Scan Date: {report_data['scan_date']}")

    if 'scans' in report_data:
        num_antiviruses = len(report_data['scans'])
        detected_antiviruses = [antivirus for antivirus, result in report_data['scans'].items() if result['detected']]
        num_detections = len(detected_antiviruses)

        print(f"\n{num_detections}/{num_antiviruses} Antiviruses Detected the File as malicious:")
        if num_detections > 0:
            for antivirus in detected_antiviruses:
                result = report_data['scans'][antivirus]['result']
                print(f"  {antivirus}: {result}")
    else:
        print("No scan results available.")
else:
    print(f"Error submitting the file for scanning: {resp.json()}")
